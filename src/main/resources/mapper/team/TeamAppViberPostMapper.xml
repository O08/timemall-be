<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.norm.timemall.app.team.mapper.TeamAppViberPostMapper">
    <sql id="tableName">
        app_viber_post
    </sql>

    <sql id="baseColumn">
        id,channel,author_brand_id,text_msg,embed,shares,comments,likes,create_at,modified_at
    </sql>


    <resultMap id="TeamAppViberFetchPostRecordRO" type="com.norm.timemall.app.team.domain.ro.TeamAppViberFetchOnePostRO">
        <id property="postId" column="postId"/>
        <result property="comments" column="comments"/>
        <result property="likes" column="likes"/>
        <result property="shares" column="shares"/>
        <result property="textMsg" column="text_msg"/>
        <result property="createdAt" column="create_at"/>


        <result property="embed"
                typeHandler="com.baomidou.mybatisplus.extension.handlers.JacksonTypeHandler"
                column="embed"/>

        <association property="author" javaType="com.norm.timemall.app.team.domain.pojo.TeamAppViberPostAuthor">
            <id property="brandId" column="authorBrandId"/>
            <result property="avatar" column="authorAvatar"/>
            <result property="brandName" column="authorName"/>
            <result property="userId" column="authorUserId"/>
            <result property="policyRel" column="policy_rel"/>
        </association>




    </resultMap>

    <select id="selectPostInfoById"  resultMap="TeamAppViberFetchPostRecordRO">

        select
         p.id as postId,p.embed,p.text_msg,p.likes,p.shares,p.comments,p.create_at,
         b.id as authorBrandId, b.avator as authorAvatar,b.brand_name as authorName,b.customer_id as authorUserId, gmr.policy_rel
        from app_viber_post p
        inner join  brand b
          on p.author_brand_id=b.id
        inner join group_member_rel gmr
          on gmr.member_id=b.customer_id
            and gmr.channel_id=p.oasis_id
            and gmr.channel_type='default'
        where p.id=#{postId}

    </select>



    <select id="selectPostPage"  resultMap="TeamAppViberFetchPostRecordRO">
        select
         p.id as postId,p.embed,p.text_msg,p.likes,p.shares,p.comments,p.create_at,
         b.id as authorBrandId, b.avator as authorAvatar,b.brand_name as authorName,b.customer_id as authorUserId,
         gmr.policy_rel
        from app_viber_post p
        inner join  brand b
          on p.author_brand_id=b.id
        inner join group_member_rel gmr
          on gmr.member_id=b.customer_id
            and gmr.channel_id=p.oasis_id
            and gmr.channel_type='default'
        where 1=1
        and p.channel = #{dto.channel}
        <if test="dto.q != null and dto.q != ''">
            AND ( locate(#{dto.q}, b.brand_name)>0
            or locate(#{dto.q}, p.text_msg)>0
            )
        </if>
        <if test="dto.endAt != null">
            and p.create_at &lt;= #{dto.endAt}
        </if>
        <if test="dto.sort != null and dto.sort != ''">
            <choose>
                <when test='dto.sort == "1"'>
                    order by p.likes desc
                </when>
                <when test='dto.sort == "2"'>
                    order by p.comments desc
                </when>
                <when test='dto.sort == "3"'>
                    order by p.shares desc
                </when>
                <when test='dto.sort == "4"'>
                    order by p.create_at desc
                </when>
            </choose>
        </if>
    </select>

</mapper>